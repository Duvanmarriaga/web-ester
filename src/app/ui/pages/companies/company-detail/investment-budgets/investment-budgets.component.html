<div class="tab-panel">
  <div class="tab-panel-header">
    <div>
      <h4 class="tab-panel-title">Presupuestos de Inversiones</h4>
    </div>
    <div class="tab-panel-actions">
      <button
        type="button"
        class="btn btn-sm btn-outline-primary"
        (click)="downloadTemplate()"
        title="Descargar plantilla XLSX"
      >
        <lucide-icon [img]="icons.Download" [size]="16"></lucide-icon>
        <span>Descargar plantilla</span>
      </button>
      <button
        type="button"
        class="btn btn-sm btn-primary"
        (click)="openCreateBudgetYearModal()"
        title="Crear nuevo presupuesto anual"
      >
        <lucide-icon [img]="icons.Plus" [size]="16"></lucide-icon>
        <span>Crear Presupuesto Anual</span>
      </button>
    </div>
  </div>
  @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else if (budgetYearsWithInvestments().length === 0 &&
  investmentsWithoutYear().length === 0) {
  <div class="empty-state">
    <lucide-icon
      [img]="icons.TrendingUp"
      [size]="48"
      class="empty-icon"
    ></lucide-icon>
    <p>No hay presupuestos de inversiones disponibles</p>
  </div>
  } @else {
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="table-header" style="width: 40px"></th>
              <th class="table-header">Año</th>
              <th class="table-header">Monto Anual</th>
              <th class="table-header text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (budgetYear of budgetYearsWithInvestments(); track
            budgetYear.id) {
            <tr class="budget-year-row">
              <td class="table-cell">
                <button
                  type="button"
                  class="btn btn-sm btn-link p-0"
                  (click)="toggleBudgetYear(budgetYear)"
                  [title]="budgetYear.isExpanded ? 'Contraer' : 'Expandir'"
                >
                  @if (budgetYear.isExpanded) {
                  <lucide-icon
                    [img]="icons.ChevronUp"
                    [size]="16"
                  ></lucide-icon>
                  } @else {
                  <lucide-icon
                    [img]="icons.ChevronDown"
                    [size]="16"
                  ></lucide-icon>
                  }
                </button>
              </td>
              <td class="table-cell fw-medium">{{ budgetYear.year }}</td>
              <td class="table-cell fw-medium">
                ${{ budgetYear.amount | number : "1.2-2" }}
              </td>
              <td class="text-end">
                <div class="row-actions">
                  <button
                    class="menu-trigger"
                    type="button"
                    title="Acciones"
                    (click)="
                      toggleMenu(getMenuId('year', budgetYear.id), $event)
                    "
                  >
                    <lucide-icon
                      [img]="icons.MoreVertical"
                      [size]="16"
                    ></lucide-icon>
                  </button>
                  @if (openMenuId() === getMenuId('year', budgetYear.id)) {
                  <div class="menu-backdrop" (click)="closeMenu()"></div>
                  <div
                    class="menu-popover"
                    [style.top.px]="openMenuTop()"
                    [style.left.px]="openMenuLeft()"
                  >
                    <button
                      class="menu-item text-primary"
                      type="button"
                      (click)="editBudgetYear(budgetYear); closeMenu()"
                    >
                      <lucide-icon
                        [img]="icons.Pencil"
                        [size]="14"
                      ></lucide-icon>
                      Editar Presupuesto Anual
                    </button>
                    <button
                      class="menu-item"
                      type="button"
                      (click)="triggerFileInput(budgetYear); closeMenu()"
                      [disabled]="isImporting()"
                    >
                      <lucide-icon
                        [img]="icons.Upload"
                        [size]="14"
                      ></lucide-icon>
                      @if (isImporting()) {
                      <span>Cargando...</span>
                      } @else {
                      <span>Cargar archivo</span>
                      }
                    </button>
                    <button
                      class="menu-item"
                      type="button"
                      (click)="openCreateModal(budgetYear.id); closeMenu()"
                    >
                      <lucide-icon [img]="icons.Plus" [size]="14"></lucide-icon>
                      Agregar Presupuesto de Inversión
                    </button>

                    <button
                      class="menu-item text-danger"
                      type="button"
                      [disabled]="!canDeleteBudgetYear(budgetYear)"
                      (click)="deleteBudgetYear(budgetYear); closeMenu()"
                    >
                      <lucide-icon
                        [img]="icons.Trash2"
                        [size]="14"
                      ></lucide-icon>
                      Eliminar Presupuesto Anual
                    </button>
                  </div>
                  }
                </div>
              </td>
            </tr>
            @if (budgetYear.isExpanded) {
            <tr class="budget-month-row">
              <td colspan="4" class="p-0">
                <div class="budget-months-container">
                  @if (budgetYear.investments.length === 0) {
                  <div class="text-center py-4 text-muted">
                    <p class="mb-0">
                      No hay presupuestos de inversión para este año
                    </p>
                  </div>
                  } @else {
                  <div class="budget-months-list">
                    @for (investment of budgetYear.investments; track
                    investment.id) {
                    <div class="budget-month-item">
                      <div class="budget-month-date-col">
                        <span class="budget-month-date fw-medium">
                          {{
                            getCategoryName(
                              investment.investment_budget_category_id
                            )
                          }}
                        </span>
                      </div>
                      <div class="budget-month-data-col">
                        <div class="budget-month-data-item">
                          <span class="budget-data-label">Monto</span>
                          <span class="budget-data-value fw-medium">
                            ${{ investment.amount | number : "1.2-2" }}
                          </span>
                        </div>
                      </div>
                      <div class="budget-month-actions-col">
                        <div class="row-actions">
                          <button
                            class="menu-trigger"
                            type="button"
                            title="Acciones"
                            (click)="
                              toggleMenu(
                                getMenuId('investment', investment.id),
                                $event
                              )
                            "
                          >
                            <lucide-icon
                              [img]="icons.MoreVertical"
                              [size]="16"
                            ></lucide-icon>
                          </button>
                          @if (openMenuId() === getMenuId('investment',
                          investment.id)) {
                          <div
                            class="menu-backdrop"
                            (click)="closeMenu()"
                          ></div>
                          <div
                            class="menu-popover"
                            [style.top.px]="openMenuTop()"
                            [style.left.px]="openMenuLeft()"
                          >
                            <button
                              class="menu-item text-primary"
                              type="button"
                              (click)="editInvestment(investment); closeMenu()"
                            >
                              <lucide-icon
                                [img]="icons.Pencil"
                                [size]="14"
                              ></lucide-icon>
                              Editar
                            </button>
                            <button
                              class="menu-item text-danger"
                              type="button"
                              (click)="
                                deleteInvestment(investment); closeMenu()
                              "
                            >
                              <lucide-icon
                                [img]="icons.Trash2"
                                [size]="14"
                              ></lucide-icon>
                              Eliminar
                            </button>
                          </div>
                          }
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                  }
                </div>
              </td>
            </tr>
            } } @if (investmentsWithoutYear().length > 0) {
            <tr>
              <td colspan="4" class="table-cell fw-bold bg-light">
                Presupuestos sin año asignado
              </td>
            </tr>
            @for (investment of investmentsWithoutYear(); track investment.id) {
            <tr>
              <td class="table-cell"></td>
              <td class="table-cell" colspan="2">
                <div class="d-flex flex-column">
                  <span class="fw-medium">Presupuesto de Inversión</span>
                  <div class="d-flex gap-3 mt-1">
                    <small>
                      <span class="text-muted">Monto:</span>
                      <span class="fw-medium"
                        >${{ investment.amount | number : "1.2-2" }}</span
                      >
                    </small>
                  </div>
                </div>
              </td>
              <td class="text-end">
                <div class="row-actions">
                  <button
                    class="menu-trigger"
                    type="button"
                    title="Acciones"
                    (click)="
                      toggleMenu(getMenuId('investment', investment.id), $event)
                    "
                  >
                    <lucide-icon
                      [img]="icons.MoreVertical"
                      [size]="16"
                    ></lucide-icon>
                  </button>
                  @if (openMenuId() === getMenuId('investment', investment.id))
                  {
                  <div class="menu-backdrop" (click)="closeMenu()"></div>
                  <div
                    class="menu-popover"
                    [style.top.px]="openMenuTop()"
                    [style.left.px]="openMenuLeft()"
                  >
                    <button
                      class="menu-item text-primary"
                      type="button"
                      (click)="editInvestment(investment); closeMenu()"
                    >
                      <lucide-icon
                        [img]="icons.Pencil"
                        [size]="14"
                      ></lucide-icon>
                      Editar
                    </button>
                    <button
                      class="menu-item text-danger"
                      type="button"
                      (click)="deleteInvestment(investment); closeMenu()"
                    >
                      <lucide-icon
                        [img]="icons.Trash2"
                        [size]="14"
                      ></lucide-icon>
                      Eliminar
                    </button>
                  </div>
                  }
                </div>
              </td>
            </tr>
            } }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  }
</div>

@if (companyId() && userId()) {
<app-investment-budget-modal
  [isVisible]="showModal()"
  [companyId]="companyId()!"
  [userId]="userId()!"
  [investment]="selectedInvestment()"
  (close)="closeModal()"
  (save)="onSaveInvestment($event)"
  (update)="onUpdateInvestment($event)"
></app-investment-budget-modal>
} @if (companyId()) {
<app-investment-budget-year-modal
  [isVisible]="showBudgetYearModal()"
  [companyId]="companyId()!"
  [budgetYear]="selectedBudgetYear()"
  (close)="closeBudgetYearModal()"
  (save)="onSaveBudgetYear($event)"
  (update)="onUpdateBudgetYear($event)"
></app-investment-budget-year-modal>
}

@if (companyId() && importingBudgetYear()) {
<app-investment-import-modal
  [isVisible]="showImportModal()"
  [companyId]="companyId()!"
  [budgetYearId]="importingBudgetYear()!.id!"
  [budgetYear]="importingBudgetYear()!.year"
  [importedData]="importedInvestments()"
  (close)="onCloseImportModal()"
  (save)="onSaveImportedInvestments($event)"
></app-investment-import-modal>
}

<app-confirm-dialog
  [isVisible]="showConfirmDialog()"
  [title]="
    isDeletingBudgetYear()
      ? 'Eliminar Presupuesto Anual de Inversión'
      : 'Eliminar Presupuesto de Inversión'
  "
  [message]="getDeleteMessage()"
  confirmText="Eliminar"
  cancelText="Cancelar"
  variant="danger"
  (confirmed)="onConfirmDelete()"
  (cancelled)="onCancelDelete()"
></app-confirm-dialog>
