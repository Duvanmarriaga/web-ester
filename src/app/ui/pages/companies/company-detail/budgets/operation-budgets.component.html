<div class="tab-panel">
  <div class="tab-panel-header">
    <div>
      <h4 class="tab-panel-title">Presupuestos de operaciones</h4>
    </div>
    <div class="tab-panel-actions">
      <button
        type="button"
        class="btn btn-sm btn-outline-primary"
        (click)="downloadTemplate()"
        title="Descargar plantilla XLSX"
      >
        <lucide-icon [img]="icons.Download" [size]="16"></lucide-icon>
        <span>Descargar plantilla</span>
      </button>
      <button
        type="button"
        class="btn btn-sm btn-primary"
        (click)="openCreateBudgetYearModal()"
        title="Crear nuevo presupuesto anual"
      >
        <lucide-icon [img]="icons.Plus" [size]="16"></lucide-icon>
        <span>Crear Presupuesto Anual</span>
      </button>
    </div>
  </div>
  @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else if (budgetYearsWithBudgets().length === 0 &&
  budgetsWithoutYear().length === 0) {
  <div class="empty-state">
    <lucide-icon
      [img]="icons.DollarSign"
      [size]="48"
      class="empty-icon"
    ></lucide-icon>
    <p>No hay presupuestos de operaciones disponibles</p>
  </div>
  } @else {
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="table-header" style="width: 40px"></th>
              <th class="table-header">Año</th>
              <th class="table-header">Monto Anual</th>
              <th class="table-header text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (budgetYear of budgetYearsWithBudgets(); track budgetYear.id) {
            <tr class="budget-year-row">
              <td class="table-cell">
                <button
                  type="button"
                  class="btn btn-sm btn-link p-0"
                  (click)="toggleBudgetYear(budgetYear)"
                  [title]="budgetYear.isExpanded ? 'Contraer' : 'Expandir'"
                >
                  @if (budgetYear.isExpanded) {
                  <lucide-icon
                    [img]="icons.ChevronUp"
                    [size]="16"
                  ></lucide-icon>
                  } @else {
                  <lucide-icon
                    [img]="icons.ChevronDown"
                    [size]="16"
                  ></lucide-icon>
                  }
                </button>
              </td>
              <td class="table-cell fw-medium">{{ budgetYear.year }}</td>
              <td class="table-cell fw-medium">
                ${{ budgetYear.allocated_budget | number : "1.2-2" }}
              </td>
              <td class="text-end">
                <div class="row-actions">
                  <button
                    class="menu-trigger"
                    type="button"
                    title="Acciones"
                    (click)="toggleMenu(getMenuId('year', budgetYear.id), $event)"
                  >
                    <lucide-icon [img]="icons.MoreVertical" [size]="16"></lucide-icon>
                  </button>
                  @if (openMenuId() === getMenuId('year', budgetYear.id)) {
                    <div class="menu-backdrop" (click)="closeMenu()"></div>
                    <div
                      class="menu-popover"
                      [style.top.px]="openMenuTop()"
                      [style.left.px]="openMenuLeft()"
                    >
                      <button
                        class="menu-item"
                        type="button"
                        (click)="triggerFileInput(budgetYear.id); closeMenu()"
                        [disabled]="isImporting() && importingYearId() === budgetYear.id"
                      >
                        @if (isImporting() && importingYearId() === budgetYear.id) {
                        <span
                          class="spinner-border spinner-border-sm"
                          role="status"
                          style="width: 14px; height: 14px;"
                        ></span>
                        } @else {
                        <lucide-icon [img]="icons.Upload" [size]="14"></lucide-icon>
                        }
                        Cargar archivo
                      </button>
                      <button
                        class="menu-item"
                        type="button"
                        (click)="openCreateModal(budgetYear.id); closeMenu()"
                      >
                        <lucide-icon [img]="icons.Plus" [size]="14"></lucide-icon>
                        Agregar Presupuesto Mensual
                      </button>
                      <button
                        class="menu-item text-primary"
                        type="button"
                        (click)="editBudgetYear(budgetYear); closeMenu()"
                      >
                        <lucide-icon [img]="icons.Pencil" [size]="14"></lucide-icon>
                        Editar Presupuesto Anual
                      </button>
                      <button
                        class="menu-item text-danger"
                        type="button"
                        [disabled]="!canDeleteBudgetYear(budgetYear)"
                        (click)="deleteBudgetYear(budgetYear); closeMenu()"
                      >
                        <lucide-icon [img]="icons.Trash2" [size]="14"></lucide-icon>
                        Eliminar Presupuesto Anual
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>
            @if (budgetYear.isExpanded) {
            <tr class="budget-month-row">
              <td colspan="4" class="p-0">
                <div class="budget-months-container">
                  @if (budgetYear.budgets.length === 0) {
                  <div class="text-center py-4 text-muted">
                    <p class="mb-0">
                      No hay presupuestos mensuales para este año
                    </p>
                  </div>
                  } @else {
                  <div class="budget-months-list">
                    @for (budget of budgetYear.budgets; track budget.id) {
                    <div class="budget-month-item">
                      <div class="budget-month-date-col">
                        <span class="budget-month-date fw-medium">
                          {{ budget.budget_date | date : "MM/yyyy" }}
                        </span>
                      </div>
                      <div class="budget-month-data-col">
                        <div class="budget-month-data-item">
                          <span class="budget-data-label">Presupuesto</span>
                          <span class="budget-data-value fw-medium">
                            ${{ budget.budget_amount | number : "1.2-2" }}
                          </span>
                        </div>
                        <div class="budget-month-data-item">
                          <span class="budget-data-label">Ejecutado</span>
                          <span class="budget-data-value">
                            ${{ budget.executed_amount | number : "1.2-2" }}
                          </span>
                        </div>
                        <div class="budget-month-data-item">
                          <span class="budget-data-label">Diferencia</span>
                          <span
                            class="budget-data-value fw-medium"
                            [class.text-success]="budget.difference_amount > 0"
                            [class.text-danger]="budget.difference_amount < 0"
                          >
                            ${{ budget.difference_amount | number : "1.2-2" }}
                          </span>
                        </div>
                        <div class="budget-month-data-item">
                          <span class="budget-data-label">Porcentaje</span>
                          <span class="budget-data-value">
                            {{ budget.percentage | number : "1.2-2" }}%
                          </span>
                        </div>
                      </div>
                      <div class="budget-month-actions-col">
                        <div class="row-actions">
                          <button
                            class="menu-trigger"
                            type="button"
                            title="Acciones"
                            (click)="toggleMenu(getMenuId('budget', budget.id), $event)"
                          >
                            <lucide-icon [img]="icons.MoreVertical" [size]="16"></lucide-icon>
                          </button>
                          @if (openMenuId() === getMenuId('budget', budget.id)) {
                            <div class="menu-backdrop" (click)="closeMenu()"></div>
                            <div
                              class="menu-popover"
                              [style.top.px]="openMenuTop()"
                              [style.left.px]="openMenuLeft()"
                            >
                              <button
                                class="menu-item text-primary"
                                type="button"
                                (click)="editBudget(budget); closeMenu()"
                              >
                                <lucide-icon [img]="icons.Pencil" [size]="14"></lucide-icon>
                                Editar
                              </button>
                              <button
                                class="menu-item text-danger"
                                type="button"
                                (click)="deleteBudget(budget); closeMenu()"
                              >
                                <lucide-icon [img]="icons.Trash2" [size]="14"></lucide-icon>
                                Eliminar
                              </button>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                  }
                </div>
              </td>
            </tr>
            } } @if (budgetsWithoutYear().length > 0) {
            <tr>
              <td colspan="4" class="table-cell fw-bold bg-light">
                Presupuestos sin año asignado
              </td>
            </tr>
            @for (budget of budgetsWithoutYear(); track budget.id) {
            <tr>
              <td class="table-cell"></td>
              <td class="table-cell" colspan="2">
                <div class="d-flex flex-column">
                  <span class="fw-medium">{{
                    budget.budget_date | date : "MM/yyyy"
                  }}</span>
                  <div class="d-flex gap-3 mt-1">
                    <small>
                      <span class="text-muted">Presupuesto:</span>
                      <span class="fw-medium"
                        >${{ budget.budget_amount | number : "1.2-2" }}</span
                      >
                    </small>
                    <small>
                      <span class="text-muted">Ejecutado:</span>
                      <span
                        >${{ budget.executed_amount | number : "1.2-2" }}</span
                      >
                    </small>
                    <small>
                      <span class="text-muted">Diferencia:</span>
                      <span
                        [class.text-success]="budget.difference_amount > 0"
                        [class.text-danger]="budget.difference_amount < 0"
                        class="fw-medium"
                      >
                        ${{ budget.difference_amount | number : "1.2-2" }}
                      </span>
                    </small>
                    <small>
                      <span class="text-muted">Porcentaje:</span>
                      <span>{{ budget.percentage | number : "1.2-2" }}%</span>
                    </small>
                  </div>
                </div>
              </td>
              <td class="text-end">
                <div class="row-actions">
                  <button
                    class="menu-trigger"
                    type="button"
                    title="Acciones"
                    (click)="toggleMenu(getMenuId('budget', budget.id), $event)"
                  >
                    <lucide-icon [img]="icons.MoreVertical" [size]="16"></lucide-icon>
                  </button>
                  @if (openMenuId() === getMenuId('budget', budget.id)) {
                    <div class="menu-backdrop" (click)="closeMenu()"></div>
                    <div
                      class="menu-popover"
                      [style.top.px]="openMenuTop()"
                      [style.left.px]="openMenuLeft()"
                    >
                      <button
                        class="menu-item text-primary"
                        type="button"
                        (click)="editBudget(budget); closeMenu()"
                      >
                        <lucide-icon [img]="icons.Pencil" [size]="14"></lucide-icon>
                        Editar
                      </button>
                      <button
                        class="menu-item text-danger"
                        type="button"
                        (click)="deleteBudget(budget); closeMenu()"
                      >
                        <lucide-icon [img]="icons.Trash2" [size]="14"></lucide-icon>
                        Eliminar
                      </button>
                    </div>
                  }
                </div>
              </td>
            </tr>
            } }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  }
</div>

@if (companyId() && userId()) {
<app-operation-budget-modal
  [isVisible]="showModal()"
  [companyId]="companyId()!"
  [userId]="userId()!"
  [budget]="selectedBudget()"
  (close)="closeModal()"
  (save)="onSaveBudget($event)"
  (update)="onUpdateBudget($event)"
></app-operation-budget-modal>
} @if (companyId()) {
<app-operation-budget-year-modal
  [isVisible]="showBudgetYearModal()"
  [companyId]="companyId()!"
  [budgetYear]="selectedBudgetYear()"
  (close)="closeBudgetYearModal()"
  (save)="onSaveBudgetYear($event)"
  (update)="onUpdateBudgetYear($event)"
></app-operation-budget-year-modal>
}

<app-confirm-dialog
  [isVisible]="showConfirmDialog()"
  [title]="
    isDeletingBudgetYear()
      ? 'Eliminar Presupuesto Anual'
      : 'Eliminar Presupuesto'
  "
  [message]="getDeleteMessage()"
  confirmText="Eliminar"
  cancelText="Cancelar"
  variant="danger"
  (confirmed)="onConfirmDelete()"
  (cancelled)="onCancelDelete()"
></app-confirm-dialog>

@if (companyId() && userId() && currentImportYearId() && importingBudgetYear()) {
<app-operation-budget-import-modal
  [isVisible]="showImportModal()"
  [companyId]="companyId()!"
  [userId]="userId()!"
  [budgetYearId]="currentImportYearId()!"
  [budgetYear]="importingBudgetYear()!.year"
  [importedData]="importedBudgets()"
  (close)="onCloseImportModal()"
  (save)="onSaveImportedBudgets($event)"
></app-operation-budget-import-modal>
}
