<div class="container-fluid py-3">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="page-title">Gestión de Compañías</h1>
    <button
      class="btn btn-sm btn-primary d-flex align-items-center gap-2"
      (click)="openCreateModal()"
    >
      <lucide-icon [img]="icons.Building2" [size]="16"></lucide-icon>
      <span>Nueva Compañía</span>
    </button>
  </div>

  <!-- Loading -->
  @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else {
  <!-- Companies Table -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 companies-table">
          <thead class="table-light">
            <tr>
              <th class="table-header col-company">Compañía</th>
              <th class="table-header col-email">Email</th>
              <th class="table-header col-phone">Teléfono</th>
              <th class="table-header col-address">Dirección</th>
              <th class="table-header col-actions text-end">Acciones</th>
            </tr>
          </thead>
      <tbody>
        @if (companies().length === 0) {
        <tr>
          <td colspan="5" class="empty-state">
            <div class="empty-state-content">
              <lucide-icon [img]="icons.Building2" [size]="48" class="empty-icon"></lucide-icon>
              <p>No hay compañías registradas</p>
            </div>
          </td>
        </tr>
        } @else {
        @for (company of companies(); track company.id) {
        <tr (click)="navigateToDetail(company.id)">
          <td class="table-cell fw-medium col-company">
            <div class="company-cell">
              <div class="company-avatar">
                <lucide-icon [img]="icons.Building2" [size]="14"></lucide-icon>
              </div>
              <div class="company-info">
                <div class="company-name">{{ company.name }}</div>
                <div class="company-nit">NIT: {{ company.identification_number }}</div>
              </div>
            </div>
          </td>
          <td class="table-cell col-email">
            <div class="email-cell">
              <lucide-icon [img]="icons.Mail" [size]="12" class="cell-icon"></lucide-icon>
              <span>{{ company.email }}</span>
            </div>
          </td>
          <td class="table-cell col-phone">
            @if (company.phone) {
            <div class="phone-cell">
              <lucide-icon [img]="icons.Phone" [size]="12" class="cell-icon"></lucide-icon>
              <span>{{ company.phone }}</span>
            </div>
            } @else {
            <span class="text-muted">-</span>
            }
          </td>
          <td class="table-cell col-address">
            <div class="address-cell">
              <lucide-icon [img]="icons.MapPin" [size]="12" class="cell-icon"></lucide-icon>
              <span class="text-truncate">{{ company.address }}</span>
            </div>
          </td>
          <td class="text-end col-actions" (click)="$event.stopPropagation()">
            <div class="d-flex gap-2 justify-content-end">
              <button
                class="btn btn-sm btn-link text-primary p-1 action-btn view-btn"
                (click)="navigateToDetail(company.id)"
                title="Ver detalle"
              >
                <lucide-icon [img]="icons.ArrowRight" [size]="14"></lucide-icon>
              </button>
              <button
                class="btn btn-sm btn-link text-primary p-1 action-btn edit-btn"
                (click)="openEditModal(company)"
                title="Editar"
              >
                <lucide-icon [img]="icons.Pencil" [size]="14"></lucide-icon>
              </button>
              <button
                class="btn btn-sm btn-link text-danger p-1 action-btn delete-btn"
                (click)="deleteCompany(company)"
                title="Eliminar"
              >
                <lucide-icon [img]="icons.Trash2" [size]="14"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
        }
        }
      </tbody>
    </table>
      </div>
    </div>
  </div>
  }

  <!-- Modal -->
  @if (showModal()) {
  <div class="modal show d-block">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ editingCompany() ? "Editar Compañía" : "Nueva Compañía" }}
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeModal()"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="companyForm" (ngSubmit)="onSubmit()">
            <div class="mb-3">
              <label for="name" class="form-label">Nombre de la Compañía</label>
              <input
                type="text"
                class="form-control"
                id="name"
                formControlName="name"
                placeholder="Empresa S.A."
              />
              @if (companyForm.get('name')?.invalid &&
              companyForm.get('name')?.touched) {
              <small class="form-error">Nombre requerido</small>
              }
            </div>
            <div class="mb-3">
              <label for="identification_number" class="form-label"
                >Número de Identificación</label
              >
              <input
                type="text"
                class="form-control"
                id="identification_number"
                formControlName="identification_number"
                placeholder="123456789"
              />
              @if (companyForm.get('identification_number')?.invalid &&
              companyForm.get('identification_number')?.touched) {
              <small class="form-error"
                >Número de identificación requerido</small
              >
              }
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                formControlName="email"
                placeholder="contacto@empresa.com"
              />
              @if (companyForm.get('email')?.invalid &&
              companyForm.get('email')?.touched) {
              <small class="form-error">Email válido requerido</small>
              }
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label"
                >Teléfono <span class="text-muted">(Opcional)</span></label
              >
              <input
                type="tel"
                class="form-control"
                id="phone"
                formControlName="phone"
                placeholder="+57 300 123 4567"
              />
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Dirección</label>
              <textarea
                class="form-control"
                id="address"
                formControlName="address"
                rows="2"
                placeholder="Calle 123 #45-67"
              ></textarea>
              @if (companyForm.get('address')?.invalid &&
              companyForm.get('address')?.touched) {
              <small class="form-error">Dirección requerida</small>
              }
            </div>
            <div class="d-flex gap-2 justify-content-end mt-4">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                (click)="closeModal()"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="btn btn-sm btn-primary"
                [disabled]="companyForm.invalid"
              >
                {{ editingCompany() ? "Actualizar" : "Crear" }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Confirm Dialog -->
  <app-confirm-dialog
    [isVisible]="showConfirmDialog()"
    [title]="'Eliminar Compañía'"
    [message]="getDeleteMessage()"
    [confirmText]="'Eliminar'"
    [cancelText]="'Cancelar'"
    [variant]="'danger'"
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
  />
</div>
