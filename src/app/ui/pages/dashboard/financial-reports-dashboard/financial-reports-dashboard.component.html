<div class="dashboard-section">
  <div class="section-header">
    <h3 class="section-title">
      <lucide-icon [img]="icons.FileText" [size]="18" class="me-2"></lucide-icon>
      Dashboard de Reportes Financieros
    </h3>
  </div>

  <!-- Filters -->
  <div class="filters-container mb-4">
    <form [formGroup]="filterForm" class="filters-form">
      <div class="row g-3">
        @if (isAdmin()) {
        <div class="col-md-4">
          <label for="filter_company_id" class="form-label">
            <lucide-icon [img]="icons.Filter" [size]="14" class="me-1"></lucide-icon>
            Compañía <span class="text-danger">*</span>
          </label>
          <ng-select
            id="filter_company_id"
            [items]="companies()"
            bindLabel="name"
            bindValue="id"
            placeholder="Seleccionar compañía"
            formControlName="company_id"
            [clearable]="false"
            [searchable]="true"
            [loading]="isLoadingCompanies()"
            appendTo="body"
          >
          </ng-select>
          @if (filterForm.get('company_id')?.invalid && filterForm.get('company_id')?.touched) {
          <small class="form-error">Compañía requerida</small>
          }
        </div>
        }
        <div [class]="isAdmin() ? 'col-md-4' : 'col-md-6'">
          <label for="filter_date_from" class="form-label">
            <lucide-icon [img]="icons.Calendar" [size]="14" class="me-1"></lucide-icon>
            Fecha Desde
          </label>
          <input
            type="date"
            class="form-control"
            id="filter_date_from"
            formControlName="date_from"
          />
        </div>
        <div [class]="isAdmin() ? 'col-md-4' : 'col-md-6'">
          <label for="filter_date_to" class="form-label">
            <lucide-icon [img]="icons.Calendar" [size]="14" class="me-1"></lucide-icon>
            Fecha Hasta
          </label>
          <input
            type="date"
            class="form-control"
            id="filter_date_to"
            formControlName="date_to"
          />
        </div>
      </div>
    </form>
  </div>

  @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  } @else {
  <!-- Financial Indicators -->
  <div class="row g-3 mb-4">
    <!-- 1. Liquidez Corriente -->
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="indicator-card">
        <div class="indicator-header">
          <h4 class="indicator-title">Liquidez Corriente</h4>
          <div class="indicator-traffic-light">
            @if (currentLiquidity() !== null) {
              <div class="traffic-light" [class.green]="currentLiquidity()! > 0" [class.red]="currentLiquidity()! <= 0">
                <div class="light"></div>
              </div>
            } @else {
              <div class="traffic-light gray">
                <div class="light"></div>
              </div>
            }
          </div>
        </div>
        <div class="indicator-value">
          @if (currentLiquidity() !== null) {
            <span [class.text-success]="currentLiquidity()! > 0" [class.text-danger]="currentLiquidity()! <= 0">
              {{ currentLiquidity()! | number : '1.2-2' }}
            </span>
          } @else {
            <span class="text-muted">N/A</span>
          }
        </div>
        <div class="indicator-formula">
          Activo Corriente / Pasivo Corriente
        </div>
      </div>
    </div>

    <!-- 2. Prueba Ácida -->
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="indicator-card">
        <div class="indicator-header">
          <h4 class="indicator-title">Prueba Ácida</h4>
          <div class="indicator-traffic-light">
            @if (acidTest() !== null) {
              <div class="traffic-light" [class.green]="acidTest()! > 0" [class.red]="acidTest()! <= 0">
                <div class="light"></div>
              </div>
            } @else {
              <div class="traffic-light gray">
                <div class="light"></div>
              </div>
            }
          </div>
        </div>
        <div class="indicator-value">
          @if (acidTest() !== null) {
            <span [class.text-success]="acidTest()! > 0" [class.text-danger]="acidTest()! <= 0">
              {{ acidTest()! | number : '1.2-2' }}
            </span>
          } @else {
            <span class="text-muted">N/A</span>
          }
        </div>
        <div class="indicator-formula">
          (Activo Corriente - Inventarios) / Pasivo Corriente
        </div>
      </div>
    </div>

    <!-- 3. Endeudamiento Total -->
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="indicator-card">
        <div class="indicator-header">
          <h4 class="indicator-title">Endeudamiento Total</h4>
          <div class="indicator-traffic-light">
            @if (totalDebt() !== null) {
              <div class="traffic-light" [class.green]="totalDebt()! > 0" [class.red]="totalDebt()! <= 0">
                <div class="light"></div>
              </div>
            } @else {
              <div class="traffic-light gray">
                <div class="light"></div>
              </div>
            }
          </div>
        </div>
        <div class="indicator-value">
          @if (totalDebt() !== null) {
            <span [class.text-success]="totalDebt()! > 0" [class.text-danger]="totalDebt()! <= 0">
              {{ totalDebt()! | number : '1.2-2' }}
            </span>
          } @else {
            <span class="text-muted">N/A</span>
          }
        </div>
        <div class="indicator-formula">
          Pasivo Total / Activo Total
        </div>
      </div>
    </div>

    <!-- 4. Margen Neto -->
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="indicator-card">
        <div class="indicator-header">
          <h4 class="indicator-title">Margen Neto</h4>
          <div class="indicator-traffic-light">
            @if (netMargin() !== null) {
              <div class="traffic-light" [class.green]="netMargin()! > 0" [class.red]="netMargin()! <= 0">
                <div class="light"></div>
              </div>
            } @else {
              <div class="traffic-light gray">
                <div class="light"></div>
              </div>
            }
          </div>
        </div>
        <div class="indicator-value">
          @if (netMargin() !== null) {
            <span [class.text-success]="netMargin()! > 0" [class.text-danger]="netMargin()! <= 0">
              {{ netMargin()! | number : '1.2-2' }}%
            </span>
          } @else {
            <span class="text-muted">N/A</span>
          }
        </div>
        <div class="indicator-formula">
          (Utilidad Neta / Ingresos Totales) × 100
        </div>
      </div>
    </div>

    <!-- 6. Variación vs Presupuesto -->
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="indicator-card">
        <div class="indicator-header">
          <h4 class="indicator-title">Variación vs Presupuesto</h4>
          <div class="indicator-traffic-light">
            @if (budgetVariance() !== null) {
              <div class="traffic-light" [class.green]="budgetVariance()! > 0" [class.red]="budgetVariance()! <= 0">
                <div class="light"></div>
              </div>
            } @else {
              <div class="traffic-light gray">
                <div class="light"></div>
              </div>
            }
          </div>
        </div>
        <div class="indicator-value">
          @if (budgetVariance() !== null) {
            <span [class.text-success]="budgetVariance()! > 0" [class.text-danger]="budgetVariance()! <= 0">
              ${{ budgetVariance()! | number : '1.0-0' }}
            </span>
          } @else {
            <span class="text-muted">N/A</span>
          }
        </div>
        <div class="indicator-formula">
          Valor Presupuestado - Valor Ejecutado
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="row g-3">
    <!-- 5. Resultado Neto YTD -->
    <div class="col-xl-6 col-lg-6 col-12">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <lucide-icon [img]="icons.BarChart3" [size]="18" class="me-2"></lucide-icon>
            Resultado Neto YTD
          </h3>
        </div>
        <div class="chart-body">
          <apx-chart
            [series]="netResultYTDChart.series"
            [chart]="netResultYTDChart.chart"
            [colors]="netResultYTDChart.colors"
            [stroke]="netResultYTDChart.stroke"
            [xaxis]="netResultYTDChart.xaxis"
            [yaxis]="netResultYTDChart.yaxis"
            [grid]="netResultYTDChart.grid"
            [dataLabels]="netResultYTDChart.dataLabels">
          </apx-chart>
        </div>
      </div>
    </div>

    <!-- 7. Caja Disponible (Runway) -->
    <div class="col-xl-6 col-lg-6 col-12">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <lucide-icon [img]="icons.Activity" [size]="18" class="me-2"></lucide-icon>
            Caja Disponible (Runway)
          </h3>
        </div>
        <div class="chart-body">
          <apx-chart
            [series]="cashRunwayChart.series"
            [chart]="cashRunwayChart.chart"
            [colors]="cashRunwayChart.colors"
            [fill]="cashRunwayChart.fill"
            [stroke]="cashRunwayChart.stroke"
            [xaxis]="cashRunwayChart.xaxis"
            [yaxis]="cashRunwayChart.yaxis"
            [grid]="cashRunwayChart.grid"
            [dataLabels]="cashRunwayChart.dataLabels">
          </apx-chart>
        </div>
      </div>
    </div>
  </div>
  }
</div>
